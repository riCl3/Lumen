<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Security Scanner Dashboard</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --safe: #22c55e;
            --medium: #f59e0b;
            --high: #ef4444;
            --unknown: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            background: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.1em;
            color: var(--text-muted);
        }

        .scan-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(12px);
        }

        .path-selector label {
            display: block;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text);
        }

        .path-input-group {
            display: flex;
            gap: 12px;
        }

        .path-input-group input {
            flex: 1;
            padding: 12px 16px;
            background: #0f172a;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1em;
            transition: all 0.2s;
        }

        .path-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-browse {
            background: #334155;
            color: white;
            white-space: nowrap;
        }

        .btn-browse:hover {
            background: #475569;
        }

        .btn-scan {
            background: var(--primary);
            color: white;
            width: 100%;
            margin-top: 20px;
            justify-content: center;
        }

        .btn-scan:hover {
            background: var(--primary-hover);
        }

        .btn-scan:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.safe::before {
            background: var(--safe);
        }

        .stat-card.medium::before {
            background: var(--medium);
        }

        .stat-card.high::before {
            background: var(--high);
        }

        .stat-card h3 {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-card.safe .stat-value {
            color: var(--safe);
        }

        .stat-card.medium .stat-value {
            color: var(--medium);
        }

        .stat-card.high .stat-value {
            color: var(--high);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .results-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
        }

        .results-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .results-header h2 {
            font-size: 1.25em;
            color: var(--text);
        }

        .scan-date {
            color: var(--text-muted);
            font-size: 0.9em;
            font-family: monospace;
        }

        .server-list {
            padding: 24px;
            display: grid;
            gap: 16px;
        }

        .server-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .server-card:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .server-name {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text);
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .risk-badge.safe {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .risk-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .risk-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .risk-badge.unknown {
            background: rgba(148, 163, 184, 0.2);
            color: #cbd5e1;
        }

        .server-details {
            color: var(--text-muted);
            font-size: 0.95em;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .server-path {
            font-family: 'JetBrains Mono', monospace;
            background: #0f172a;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #cbd5e1;
            margin-bottom: 16px;
            word-break: break-all;
            border: 1px solid var(--border);
        }

        .risk-breakdown {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .risk-breakdown h4 {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .risk-breakdown ul {
            list-style: none;
        }

        .risk-breakdown li {
            padding: 4px 0;
            color: var(--text);
            font-size: 0.95em;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .risk-breakdown li::before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-results svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }

        .spinner {
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        #fileBrowserModal>div {
            background: var(--card-bg) !important;
            border: 1px solid var(--border);
            color: var(--text);
        }

        #fileBrowserModal h3 {
            color: var(--text);
        }

        #fileBrowserModal button {
            color: var(--text-muted);
        }

        #fileBrowserModal button:hover {
            color: var(--text);
        }

        #browserCurrentPath {
            background: #0f172a !important;
            border-color: var(--border) !important;
            color: var(--text) !important;
        }

        #browserList {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        #browserList>div {
            border-bottom: 1px solid var(--border) !important;
            color: var(--text);
        }

        #browserList>div:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîí MCP Security Scanner</h1>
            <p>Analyze and visualize MCP server security risks</p>
        </div>

        <div class="scan-panel">
            <div class="path-selector">
                <label for="pathInput">Select Directory Path</label>
                <div class="path-input-group">
                    <input type="text" id="pathInput" placeholder="e.g., D:\AlignProject\Hackathon\Lumen\mcp-shodan"
                        value="D:\AlignProject\Hackathon\Lumen\mcp-shodan">
                    <button class="btn btn-browse" onclick="browsePath()">
                        üìÅ Browse
                    </button>
                </div>
            </div>
            <button class="btn btn-scan" onclick="scanPath()">
                üîç Start Scan
            </button>
            <div style="margin-top: 10px; text-align: center;">
                <button type="button" onclick="testLLM()" style="
                    background: transparent; 
                    border: 1px solid var(--border); 
                    color: var(--text-muted); 
                    padding: 8px 16px; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 0.9em;">
                    üì° Test OpenRouter Connection
                </button>
            </div>
        </div>



        <div class="results-section">
            <div class="results-header">
                <h2>Scan Results</h2>
                <p id="scanDate">No scans yet</p>
            </div>

            <div id="loadingState" class="hidden" style="
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 25px;
                margin-bottom: 20px;
            ">
                <div style="text-align: center; color: var(--text);">
                    <div style="
                        display: inline-block;
                        width: 50px;
                        height: 50px;
                        border: 4px solid var(--border);
                        border-top-color: var(--primary);
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin-bottom: 15px;
                    "></div>
                    <h3 style="margin: 0 0 10px 0;">Scanning in Progress...</h3>
                    <p style="color: var(--text-muted); margin: 0;">Analyzing MCP servers with AI</p>
                </div>

                <div style="
                    margin-top: 15px;
                    padding: 15px;
                    background: #0f172a;
                    border-radius: 8px;
                    max-height: 200px;
                    overflow-y: auto;
                    font-family: 'Courier New', monospace;
                    font-size: 0.85em;
                    color: #94a3b8;
                ">
                    <div id="logContent">Waiting for logs...</div>
                </div>
            </div>

            <div id="noResults" class="no-results">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <h3>No Results Yet</h3>
                <p>Enter a path and click "Start Scan" to begin</p>
            </div>

            <div id="serverList" class="server-list" style="display: none;"></div>
        </div>

        <!-- File Browser Modal -->
        <div id="fileBrowserModal" class="hidden"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
            <div
                style="background: white; border-radius: 10px; width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <div
                    style="padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">Select Directory</h3>
                    <button onclick="closeFileBrowser()"
                        style="background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
                </div>

                <div style="padding: 10px 20px; background: #f8fafc; border-bottom: 1px solid #e0e0e0;">
                    <input type="text" id="browserCurrentPath" readonly
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #555;">
                </div>

                <div id="browserList" style="flex: 1; overflow-y: auto; padding: 10px;">
                    <!-- Items will be injected here -->
                </div>

                <div
                    style="padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="btn" onclick="closeFileBrowser()"
                        style="background: #e2e8f0; color: #333;">Cancel</button>
                    <button class="btn" onclick="selectCurrentPath()" style="background: #10b981; color: white;">Select
                        This Folder</button>
                </div>
            </div>
        </div>

        <script>
            // --- Log Polling Logic ---
            let logPollInterval;

            function startLogPolling() {
                console.log("Starting log polling...");

                // Clear previous logs
                fetch('/api/logs', { method: 'DELETE' }).catch(e => console.error("Clear logs error:", e));
                const logContent = document.getElementById('logContent');
                if (logContent) logContent.innerHTML = 'Initializing...';

                // Start polling immediately
                pollLogs();
                logPollInterval = setInterval(pollLogs, 1000);
            }

            async function pollLogs() {
                try {
                    const res = await fetch('/api/logs');
                    if (res.ok) {
                        const data = await res.json();
                        const logs = data.logs || [];
                        const logContent = document.getElementById('logContent');
                        const logContainer = document.getElementById('logContainer');

                        if (logs.length > 0) {
                            logContent.innerHTML = logs.map(l => `<div style="margin: 2px 0; font-family: monospace;">${l}</div>`).join('');
                            if (logContainer) {
                                logContainer.scrollTop = logContainer.scrollHeight;
                            }
                        } else {
                            logContent.innerHTML = 'No logs yet...';
                        }
                    }
                } catch (e) {
                    console.error("Log polling error:", e);
                }
            }

            function stopLogPolling() {
                console.log("Stopping log polling...");
                if (logPollInterval) {
                    clearInterval(logPollInterval);
                    logPollInterval = null;
                }
            }

            async function scanPath() {
                const path = document.getElementById('pathInput').value;

                if (!path.trim()) {
                    alert('Please enter a valid path');
                    return;
                }

                console.log("Starting scan for path:", path);

                // Clear old logs
                await fetch('/api/logs', { method: 'DELETE' });

                // Show loading state
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('noResults').classList.add('hidden');
                const serverList = document.getElementById('serverList');
                if (serverList) serverList.style.display = 'none';

                // Start logging BEFORE the API call
                startLogPolling();

                try {
                    console.log("Sending scan request to /api/scan...");
                    const res = await fetch('/api/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path })
                    });
                    console.log("Scan response status:", res.status);

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ detail: "Network error" }));
                        throw new Error(err.detail || "Scan failed");
                    }

                    const data = await res.json();
                    console.log("Scan data received:", data);
                    displayResults(data);

                } catch (e) {
                    console.error("Scan error:", e);
                    alert("Error: " + e.message);
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('noResults').classList.remove('hidden'); // Show empty state again
                } finally {
                    stopLogPolling();
                }
            }

            function displayResults(data) {
                console.log("Displaying results:", data);

                // Hide loading
                const loadingEl = document.getElementById('loadingState');
                if (loadingEl) loadingEl.classList.add('hidden');

                // Update scan date
                const scanDate = new Date(data.scan_date || Date.now());
                const scanDateEl = document.getElementById('scanDate');
                if (scanDateEl) scanDateEl.textContent = `Last scan: ${scanDate.toLocaleString()}`;

                // Get serverList element
                let serverList = document.getElementById('serverList');
                if (!serverList) {
                    console.error('serverList element not found!');
                    return;
                }

                serverList.innerHTML = '';

                if (data.servers && data.servers.length > 0) {
                    const noResults = document.getElementById('noResults');
                    if (noResults) noResults.classList.add('hidden');
                    serverList.style.display = 'block'; // Show server list

                    data.servers.forEach(server => {
                        const serverCard = createServerCard(server);
                        serverList.appendChild(serverCard);
                    });
                } else {
                    const noResults = document.getElementById('noResults');
                    if (noResults) noResults.classList.remove('hidden');
                    serverList.style.display = 'none'; // Hide server list
                }
            }

            async function testLLM() {
                // Show logs window to see progress
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('noResults').classList.add('hidden');

                // Clear and start polling logs
                startLogPolling();

                try {
                    const res = await fetch('/api/test-llm', { method: 'POST' });
                    const data = await res.json();

                    if (res.ok) {
                        alert(`Success! LLM Response: ${data.response}`);
                    } else {
                        alert(`Failed: ${data.detail || "Unknown error"}`);
                    }
                } catch (e) {
                    alert("Test Error: " + e.message);
                } finally {
                    document.getElementById('loadingState').classList.add('hidden');
                }
            }

            async function testLogs() {
                // Show logs window
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('noResults').classList.add('hidden');

                // Start polling
                console.log("Starting log polling for test...");
                startLogPolling();

                try {
                    const res = await fetch('/api/test-logs', { method: 'POST' });
                    const data = await res.json();

                    console.log("Test logs response:", data);

                    // Keep polling for 5 seconds to see logs
                    await new Promise(resolve => setTimeout(resolve, 5000));

                    alert("Test complete. Check the log window above.");
                } catch (e) {
                    alert("Test Error: " + e.message);
                } finally {
                    stopLogPolling();
                    document.getElementById('loadingState').classList.add('hidden');
                }
            }
            function createServerCard(server) {
                const card = document.createElement('div');
                card.className = 'server-card';

                const riskClass = server.risk_analysis?.risk_level?.toLowerCase() || 'safe';

                // Create security checklist HTML if available
                let checklistHTML = '';
                if (server.risk_analysis?.security_checklist) {
                    const checklist = server.risk_analysis.security_checklist;
                    const checklistItems = [
                        { key: 'prompt_injection', label: 'Prompt Injection' },
                        { key: 'data_exfiltration', label: 'Data Exfiltration' },
                        { key: 'tool_poisoning', label: 'Tool Poisoning/Shadowing' },
                        { key: 'unauthorized_code_execution', label: 'Unauthorized Code Execution' },
                        { key: 'system_manipulation', label: 'System Manipulation' },
                        { key: 'safety_harms', label: 'Safety Harms' },
                        { key: 'docstring_mismatch', label: 'Docstring-to-Code Mismatch' },
                        { key: 'cross_file_dataflow', label: 'Cross-File Dataflow Issues' },
                        { key: 'hidden_behavior', label: 'Hidden Behavior' },
                        { key: 'yara_patterns', label: 'YARA Patterns Detected' },
                        { key: 'ai_defense_violations', label: 'AI Defense Violations' },
                        { key: 'initialize_instructions', label: 'InitializeResult Issues' },
                        { key: 'input_schema_issues', label: 'Input Schema Issues' },
                        { key: 'mime_type_issues', label: 'MIME Type Issues' }
                    ];

                    checklistHTML = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 0.9em;">‚úÖ Security Criteria Checklist</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                ${checklistItems.map(item => {
                        const hasIssue = checklist[item.key] === true;
                        const icon = hasIssue ? '‚ùå' : '‚úÖ';
                        const color = hasIssue ? '#ef4444' : '#10b981';
                        const status = hasIssue ? 'YES' : 'NO';

                        return `
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            padding: 6px 10px;
                                            background: #1e293b;
                                            border-radius: 6px;
                                            font-size: 0.85em;
                                        ">
                                            <span style="font-size: 1.2em;">${icon}</span>
                                            <span style="flex: 1; color: var(--text);">${item.label}</span>
                                            <span style="
                                                padding: 2px 6px;
                                                background: ${color}20;
                                                color: ${color};
                                                border-radius: 4px;
                                                font-size: 0.75em;
                                                font-weight: 600;
                                            ">${status}</span>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Create threat breakdown HTML if available
                let threatsHTML = '';
                if (server.risk_analysis?.breakdown && server.risk_analysis.breakdown.length > 0) {
                    threatsHTML = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 0.9em;">üîç Detailed Threat Analysis</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${server.risk_analysis.breakdown.map(threat => {
                        const severity = threat.severity || 'low';
                        const severityColors = {
                            'low': '#3b82f6',
                            'medium': '#f59e0b',
                            'high': '#ef4444',
                            'critical': '#dc2626'
                        };
                        const severityColor = severityColors[severity] || '#94a3b8';

                        return `
                                        <div style="
                                            background: #1e293b;
                                            border-left: 3px solid ${severityColor};
                                            padding: 12px;
                                            border-radius: 6px;
                                        ">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                                <span style="
                                                    padding: 2px 8px;
                                                    background: ${severityColor}20;
                                                    color: ${severityColor};
                                                    border-radius: 4px;
                                                    font-size: 0.75em;
                                                    font-weight: 600;
                                                    text-transform: uppercase;
                                                ">${severity}</span>
                                                ${threat.threat_type ? `<span style="color: var(--text-muted); font-size: 0.85em;">${threat.threat_type}</span>` : ''}
                                            </div>
                                            <p style="
                                                margin: 0;
                                                color: var(--text);
                                                font-size: 0.9em;
                                                line-height: 1.5;
                                            ">${threat.description || 'No description provided'}</p>
                                            ${threat.snippet ? `
                                                <pre style="
                                                    margin: 8px 0 0 0;
                                                    padding: 8px;
                                                    background: #0f172a;
                                                    border-radius: 4px;
                                                    overflow-x: auto;
                                                    font-size: 0.8em;
                                                    color: #94a3b8;
                                                "><code>${threat.snippet}</code></pre>
                                            ` : ''}
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="server-header">
                        <h3>${server.name}</h3>
                        <span class="risk-badge ${riskClass}">${server.risk_analysis?.risk_level || 'UNKNOWN'}</span>
                    </div>
                    <div class="server-details">
                        <p><strong>Type:</strong> ${server.type}</p>
                        <p><strong>Description:</strong> ${server.description}</p>
                        <p><strong>Path:</strong> <code>${server.path}</code></p>
                    </div>
                    ${server.risk_analysis ? `
                        <div class="risk-analysis">
                            <h4>Risk Analysis:</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div style="
                                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                                    padding: 20px;
                                    border-radius: 10px;
                                    text-align: center;
                                    color: white;
                                ">
                                    <div style="font-size: 2.5em; font-weight: 700; margin-bottom: 5px;">
                                        ${server.risk_analysis.risk_score}/10
                                    </div>
                                    <div style="font-size: 0.9em; opacity: 0.95;">Risk Score</div>
                                    <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Lower is Better</div>
                                </div>
                                
                                <div style="
                                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                    padding: 20px;
                                    border-radius: 10px;
                                    text-align: center;
                                    color: white;
                                ">
                                    <div style="font-size: 2.5em; font-weight: 700; margin-bottom: 5px;">
                                        ${Math.max(0, 100 - (server.risk_analysis.risk_score * 10))}
                                    </div>
                                    <div style="font-size: 0.9em; opacity: 0.95;">Safety Score</div>
                                    <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Higher is Better</div>
                                </div>
                            </div>
                            
                            ${checklistHTML}
                            ${threatsHTML}
                        </div>
                    ` : ''}
                `;

                return card;
            }

            // --- File Browser Logic ---
            let currentBrowserPath = "";

            function browsePath() {
                document.getElementById('fileBrowserModal').style.display = 'flex';
                // Start at root if input is empty, or try to start at input path
                const currentInput = document.getElementById('pathInput').value;
                loadBrowserPath(currentInput || "");
            }

            function closeFileBrowser() {
                document.getElementById('fileBrowserModal').style.display = 'none';
            }

            async function loadBrowserPath(path) {
                currentBrowserPath = path;
                document.getElementById('browserCurrentPath').value = path || "Root";

                const list = document.getElementById('browserList');
                list.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';

                try {
                    const res = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                    if (!res.ok) throw new Error("Failed to list directory");

                    const items = await res.json();
                    renderBrowserList(items);
                } catch (e) {
                    console.error(e);
                    // Fallback to root if failed (e.g. invalid path)
                    if (path !== "") {
                        loadBrowserPath("");
                    } else {
                        list.innerHTML = '<div style="color: red; padding: 20px;">Failed to load drives.</div>';
                    }
                }
            }

            function renderBrowserList(items) {
                const list = document.getElementById('browserList');
                list.innerHTML = '';

                if (items.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; color: #666;">Empty directory</div>';
                    return;
                }

                items.forEach(item => {
                    const el = document.createElement('div');
                    el.style.cssText = 'padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center;';
                    el.onmouseover = () => el.style.background = '#f1f5f9';
                    el.onmouseout = () => el.style.background = 'transparent';

                    let icon = 'üìÅ';
                    if (item.type === 'drive') icon = 'üíæ';
                    if (item.type === 'parent') icon = '‚¨ÜÔ∏è';

                    el.innerHTML = `<span style="margin-right: 10px; font-size: 1.2em;">${icon}</span> ${item.name}`;
                    el.onclick = () => loadBrowserPath(item.path);

                    list.appendChild(el);
                });
            }

            function selectCurrentPath() {
                if (currentBrowserPath) {
                    document.getElementById('pathInput').value = currentBrowserPath;
                    closeFileBrowser();
                } else {
                    alert("Please navigate to a directory first.");
                }
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById('fileBrowserModal');
                if (event.target == modal) {
                    closeFileBrowser();
                }
            }

            // Optional: Load results on page load if you have a default path
            // window.onload = () => {
            //     scanPath();
            // };
        </script>
</body>

</html>